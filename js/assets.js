/*!
 * release-front <https://github.com/nabijaczleweli/release-front>
 * Copyright 2018 nabijaczleweli <https://nabijaczleweli.xyz>
 * Available under MIT license <https://opensource.org/licenses/mit>
 */
(function (global, factory) {
	if (typeof define === "function" && define.amd) {
		define(["exports", "./platform-detect", "./string"], factory);
	} else if (typeof exports !== "undefined") {
		factory(exports, require("./platform-detect"), require("./string"));
	} else {
		var mod = {
			exports: {}
		};
		factory(mod.exports, global.platformDetect, global.string);
		global.assets = mod.exports;
	}
})(this, function (exports, _platformDetect, _string) {
	"use strict";

	Object.defineProperty(exports, "__esModule", {
		value: true
	});
	exports.rank_assets = rank_assets;
	exports.specifies_assets_for = specifies_assets_for;
	exports.extract_asset_for = extract_asset_for;

	var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
		return typeof obj;
	} : function (obj) {
		return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
	};

	var PACK_EXTENSIONS = [".tar", ".tgz", ".tgz2", ".tbz2", ".xz", ".zip"];

	var WINDOWS_REGEXES = [/\.exe$/];
	var LINUX_REGEXES = [/\.out$/, /^[^.]+$/];
	var MAC_REGEXES = [/\.dmg$/];

	var MANUAL_REGEX = /man/i;
	var DOCUMENTATION_REGEX = /doc/i;

	var PLATFORMS_REGEXES = {};
	PLATFORMS_REGEXES[_platformDetect.Platform.Windows] = WINDOWS_REGEXES;
	PLATFORMS_REGEXES[_platformDetect.Platform.Linux] = LINUX_REGEXES;
	PLATFORMS_REGEXES[_platformDetect.Platform.Mac] = MAC_REGEXES;

	var PLATFORM_NAME_REGEXES = _platformDetect.Platform.all.map(function (_) {
		return new RegExp(_platformDetect.Platform.name(_), "i");
	});

	function rank_assets(project_name, tag_name, assets, platform) {
		if (_platformDetect.Platform.all.indexOf(platform) !== -1 && Array.isArray(assets) && tag_name && project_name) {
			var project_man = MANUAL_REGEX.test(project_name);
			var project_doc = DOCUMENTATION_REGEX.test(project_name);
			var platform_name = _platformDetect.Platform.name(platform);
			var platform_name_regex = new RegExp(platform_name, "i");

			return assets.map(function (data) {
				var data_name_reduced = data.name;
				for (var ext = ""; ext !== undefined; ext = PACK_EXTENSIONS.find(function (_) {
					return data_name_reduced.endsWith(_);
				})) {
					data_name_reduced = data_name_reduced.substr(0, data_name_reduced.length - ext.length);
				}data_name_reduced = (0, _string.replace_all)(data_name_reduced, tag_name, "");
				if (tag_name.startsWith("v")) data_name_reduced = (0, _string.replace_all)(data_name_reduced, tag_name.substr(1), "");

				var score = 0;

				if (PLATFORMS_REGEXES[platform].some(function (_) {
					return _.test(data_name_reduced);
				})) score += 2;

				if (platform_name_regex.test(data_name_reduced)) score += 1;

				if (!project_man && MANUAL_REGEX.test(data_name_reduced)) score -= 1;

				if (!project_doc && DOCUMENTATION_REGEX.test(data_name_reduced)) score -= 1;

				return { score: score, data: data };
			});
		} else return [];
	}

	function specifies_assets_for(config_asset_spec, platform) {
		if (_platformDetect.Platform.all.indexOf(platform) !== -1 && (typeof config_asset_spec === "undefined" ? "undefined" : _typeof(config_asset_spec)) === "object" && config_asset_spec !== null) return Object.keys(config_asset_spec).some(function (_) {
			return PLATFORM_NAME_REGEXES[platform].test(_) && config_asset_spec[_] !== null;
		});else return false;
	}

	function extract_asset_for(config_asset_spec, platform, assets, tag_name) {
		if (tag_name && Array.isArray(assets) && specifies_assets_for(config_asset_spec, platform)) {
			var template = Object.keys(config_asset_spec).find(function (_) {
				return PLATFORM_NAME_REGEXES[platform].test(_);
			});
			if (template === null || (template = config_asset_spec[template]) === null) return null;

			var tag_name_reduced = tag_name;
			if (tag_name_reduced.startsWith("v")) tag_name_reduced = tag_name_reduced.substr(1);

			template = (0, _string.replace_all)(template, "${TAG_NAME}", tag_name);
			template = (0, _string.replace_all)(template, "${TAG_NAME_REDUCED}", tag_name_reduced);

			return assets.find(function (_) {
				return _.name === template;
			}) || null;
		} else return null;
	}
});

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9qcy9hc3NldHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O1NBOERnQixXLEdBQUEsVztTQTBDQSxvQixHQUFBLG9CO1NBb0JBLGlCLEdBQUEsaUI7Ozs7Ozs7O0FBakdoQixLQUFNLGtCQUFrQixDQUFDLE1BQUQsRUFBUyxNQUFULEVBQWlCLE9BQWpCLEVBQTBCLE9BQTFCLEVBQW1DLEtBQW5DLEVBQTBDLE1BQTFDLENBQXhCOztBQUdBLEtBQU0sa0JBQWtCLENBQUMsUUFBRCxDQUF4QjtBQUNBLEtBQU0sZ0JBQWtCLENBQUMsUUFBRCxFQUFXLFNBQVgsQ0FBeEI7QUFDQSxLQUFNLGNBQWtCLENBQUMsUUFBRCxDQUF4Qjs7QUFFQSxLQUFNLGVBQXNCLE1BQTVCO0FBQ0EsS0FBTSxzQkFBc0IsTUFBNUI7O0FBRUEsS0FBTSxvQkFBZ0MsRUFBdEM7QUFDQSxtQkFBa0IseUJBQVMsT0FBM0IsSUFBc0MsZUFBdEM7QUFDQSxtQkFBa0IseUJBQVMsS0FBM0IsSUFBc0MsYUFBdEM7QUFDQSxtQkFBa0IseUJBQVMsR0FBM0IsSUFBc0MsV0FBdEM7O0FBRUEsS0FBTSx3QkFBd0IseUJBQVMsR0FBVCxDQUFhLEdBQWIsQ0FBaUI7QUFBQSxTQUFLLElBQUksTUFBSixDQUFXLHlCQUFTLElBQVQsQ0FBYyxDQUFkLENBQVgsRUFBNkIsR0FBN0IsQ0FBTDtBQUFBLEVBQWpCLENBQTlCOztBQW9CTyxVQUFTLFdBQVQsQ0FBcUIsWUFBckIsRUFBbUMsUUFBbkMsRUFBNkMsTUFBN0MsRUFBcUQsUUFBckQsRUFBK0Q7QUFDckUsTUFBRyx5QkFBUyxHQUFULENBQWEsT0FBYixDQUFxQixRQUFyQixNQUFtQyxDQUFDLENBQXBDLElBQXlDLE1BQU0sT0FBTixDQUFjLE1BQWQsQ0FBekMsSUFBa0UsUUFBbEUsSUFBOEUsWUFBakYsRUFBK0Y7QUFDOUYsT0FBSSxjQUFzQixhQUFhLElBQWIsQ0FBa0IsWUFBbEIsQ0FBMUI7QUFDQSxPQUFJLGNBQXNCLG9CQUFvQixJQUFwQixDQUF5QixZQUF6QixDQUExQjtBQUNBLE9BQUksZ0JBQXNCLHlCQUFTLElBQVQsQ0FBYyxRQUFkLENBQTFCO0FBQ0EsT0FBSSxzQkFBc0IsSUFBSSxNQUFKLENBQVcsYUFBWCxFQUEwQixHQUExQixDQUExQjs7QUFFQSxVQUFPLE9BQU8sR0FBUCxDQUFXLGdCQUFRO0FBQ3pCLFFBQUksb0JBQW9CLEtBQUssSUFBN0I7QUFDQSxTQUFJLElBQUksTUFBTSxFQUFkLEVBQWtCLFFBQVEsU0FBMUIsRUFBcUMsTUFBTSxnQkFBZ0IsSUFBaEIsQ0FBcUI7QUFBQSxZQUFLLGtCQUFrQixRQUFsQixDQUEyQixDQUEzQixDQUFMO0FBQUEsS0FBckIsQ0FBM0M7QUFDQyx5QkFBb0Isa0JBQWtCLE1BQWxCLENBQXlCLENBQXpCLEVBQTRCLGtCQUFrQixNQUFsQixHQUEyQixJQUFJLE1BQTNELENBQXBCO0FBREQsS0FFQSxvQkFBb0IseUJBQVksaUJBQVosRUFBK0IsUUFBL0IsRUFBeUMsRUFBekMsQ0FBcEI7QUFDQSxRQUFHLFNBQVMsVUFBVCxDQUFvQixHQUFwQixDQUFILEVBQ0Msb0JBQW9CLHlCQUFZLGlCQUFaLEVBQStCLFNBQVMsTUFBVCxDQUFnQixDQUFoQixDQUEvQixFQUFtRCxFQUFuRCxDQUFwQjs7QUFFRCxRQUFJLFFBQVEsQ0FBWjs7QUFFQSxRQUFHLGtCQUFrQixRQUFsQixFQUE0QixJQUE1QixDQUFpQztBQUFBLFlBQUssRUFBRSxJQUFGLENBQU8saUJBQVAsQ0FBTDtBQUFBLEtBQWpDLENBQUgsRUFDQyxTQUFTLENBQVQ7O0FBRUQsUUFBRyxvQkFBb0IsSUFBcEIsQ0FBeUIsaUJBQXpCLENBQUgsRUFDQyxTQUFTLENBQVQ7O0FBRUQsUUFBRyxDQUFDLFdBQUQsSUFBZ0IsYUFBYSxJQUFiLENBQWtCLGlCQUFsQixDQUFuQixFQUNDLFNBQVMsQ0FBVDs7QUFFRCxRQUFHLENBQUMsV0FBRCxJQUFnQixvQkFBb0IsSUFBcEIsQ0FBeUIsaUJBQXpCLENBQW5CLEVBQ0MsU0FBUyxDQUFUOztBQUVELFdBQU8sRUFBQyxZQUFELEVBQVEsVUFBUixFQUFQO0FBQ0EsSUF2Qk0sQ0FBUDtBQXdCQSxHQTlCRCxNQStCQyxPQUFPLEVBQVA7QUFDRDs7QUFTTSxVQUFTLG9CQUFULENBQThCLGlCQUE5QixFQUFpRCxRQUFqRCxFQUEyRDtBQUNqRSxNQUFHLHlCQUFTLEdBQVQsQ0FBYSxPQUFiLENBQXFCLFFBQXJCLE1BQW1DLENBQUMsQ0FBcEMsSUFBeUMsUUFBTyxpQkFBUCx5Q0FBTyxpQkFBUCxPQUE2QixRQUF0RSxJQUFrRixzQkFBc0IsSUFBM0csRUFDQyxPQUFPLE9BQU8sSUFBUCxDQUFZLGlCQUFaLEVBQStCLElBQS9CLENBQW9DO0FBQUEsVUFBSyxzQkFBc0IsUUFBdEIsRUFBZ0MsSUFBaEMsQ0FBcUMsQ0FBckMsS0FBMkMsa0JBQWtCLENBQWxCLE1BQXlCLElBQXpFO0FBQUEsR0FBcEMsQ0FBUCxDQURELEtBR0MsT0FBTyxLQUFQO0FBQ0Q7O0FBZU0sVUFBUyxpQkFBVCxDQUEyQixpQkFBM0IsRUFBOEMsUUFBOUMsRUFBd0QsTUFBeEQsRUFBZ0UsUUFBaEUsRUFBMEU7QUFDaEYsTUFBRyxZQUFZLE1BQU0sT0FBTixDQUFjLE1BQWQsQ0FBWixJQUFxQyxxQkFBcUIsaUJBQXJCLEVBQXdDLFFBQXhDLENBQXhDLEVBQTJGO0FBQzFGLE9BQUksV0FBVyxPQUFPLElBQVAsQ0FBWSxpQkFBWixFQUErQixJQUEvQixDQUFvQztBQUFBLFdBQUssc0JBQXNCLFFBQXRCLEVBQWdDLElBQWhDLENBQXFDLENBQXJDLENBQUw7QUFBQSxJQUFwQyxDQUFmO0FBQ0EsT0FBRyxhQUFhLElBQWIsSUFBcUIsQ0FBQyxXQUFXLGtCQUFrQixRQUFsQixDQUFaLE1BQTZDLElBQXJFLEVBQ0MsT0FBTyxJQUFQOztBQUVELE9BQUksbUJBQW1CLFFBQXZCO0FBQ0EsT0FBRyxpQkFBaUIsVUFBakIsQ0FBNEIsR0FBNUIsQ0FBSCxFQUNDLG1CQUFtQixpQkFBaUIsTUFBakIsQ0FBd0IsQ0FBeEIsQ0FBbkI7O0FBRUQsY0FBVyx5QkFBWSxRQUFaLEVBQXNCLGFBQXRCLEVBQXFDLFFBQXJDLENBQVg7QUFDQSxjQUFXLHlCQUFZLFFBQVosRUFBc0IscUJBQXRCLEVBQTZDLGdCQUE3QyxDQUFYOztBQUVBLFVBQU8sT0FBTyxJQUFQLENBQVk7QUFBQSxXQUFLLEVBQUUsSUFBRixLQUFXLFFBQWhCO0FBQUEsSUFBWixLQUF5QyxJQUFoRDtBQUNBLEdBYkQsTUFjQyxPQUFPLElBQVA7QUFDRCIsImZpbGUiOiJzdGRvdXQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUaGUgTUlUIExpY2Vuc2UgKE1JVClcbi8vXG4vLyBDb3B5cmlnaHQgKGMpIDIwMTggbmFiaWphY3psZXdlbGlcbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsXG4vLyBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEVcbi8vIFNPRlRXQVJFLlxuXG5cbmltcG9ydCB7UGxhdGZvcm19IGZyb20gXCIuL3BsYXRmb3JtLWRldGVjdFwiO1xuaW1wb3J0IHtyZXBsYWNlX2FsbH0gZnJvbSBcIi4vc3RyaW5nXCI7XG5cblxuY29uc3QgUEFDS19FWFRFTlNJT05TID0gW1wiLnRhclwiLCBcIi50Z3pcIiwgXCIudGd6MlwiLCBcIi50YnoyXCIsIFwiLnh6XCIsIFwiLnppcFwiXTtcblxuLy8gUmVtZW1iZXIgdG8gdXBkYXRlIGluIFJFQURNRS5tZFxuY29uc3QgV0lORE9XU19SRUdFWEVTID0gWy9cXC5leGUkL107XG5jb25zdCBMSU5VWF9SRUdFWEVTICAgPSBbL1xcLm91dCQvLCAvXlteLl0rJC9dO1xuY29uc3QgTUFDX1JFR0VYRVMgICAgID0gWy9cXC5kbWckL107XG5cbmNvbnN0IE1BTlVBTF9SRUdFWCAgICAgICAgPSAvbWFuL2k7XG5jb25zdCBET0NVTUVOVEFUSU9OX1JFR0VYID0gL2RvYy9pO1xuXG5jb25zdCBQTEFURk9STVNfUkVHRVhFUyAgICAgICAgICAgICA9IHt9O1xuUExBVEZPUk1TX1JFR0VYRVNbUGxhdGZvcm0uV2luZG93c10gPSBXSU5ET1dTX1JFR0VYRVM7XG5QTEFURk9STVNfUkVHRVhFU1tQbGF0Zm9ybS5MaW51eF0gICA9IExJTlVYX1JFR0VYRVM7XG5QTEFURk9STVNfUkVHRVhFU1tQbGF0Zm9ybS5NYWNdICAgICA9IE1BQ19SRUdFWEVTO1xuXG5jb25zdCBQTEFURk9STV9OQU1FX1JFR0VYRVMgPSBQbGF0Zm9ybS5hbGwubWFwKF8gPT4gbmV3IFJlZ0V4cChQbGF0Zm9ybS5uYW1lKF8pLCBcImlcIikpO1xuXG5cbi8vLyBSYW5rIHRoZSBzcGVjaWZpZWQgYXNzZXRzIGFjY29yZGluZyB0byB0aGVpciBzdWl0YWJpbGl0eSBmb3IgdGhlIHNwZWNpZmllZCBwbGF0Zm9ybSBhbmQgcHJvamVjdC5cbi8vL1xuLy8vIElmIGFuIGFzc2V0IG1hdGNoZXMgb25lIG9mIHRoZSBleGN1dGFibGUgcmVnZXhlcyBmb3IgdGhlIHBsYXRmb3JtLCBpdCdzIGdyYW50ZWQgMiBwb2ludHMuXG4vLy9cbi8vLyBJZiBhbiBhc3NldCBjb250YWlucyB0aGUgbmFtZSBvZiB0aGUgcGxhdGZvcm0sIGl0J3MgZ3JhbnRlZCAxIHBvaW50LlxuLy8vXG4vLy8gSWYgYW4gYXNzZXQgbWF0Y2hlcyB0aGUgbWFudWFsIHJlZ2V4IGFuZCB0aGUgcHJvamVjdCBuYW1lIGRvZXMgbm90LCBpdCdzIHN1YnN0cmFjdGVkIDEgcG9pbnQuXG4vLy9cbi8vLyBJZiBhbiBhc3NldCBtYXRjaGVzIHRoZSBkb2N1bWVudGF0aW9uIHJlZ2V4IGFuZCB0aGUgcHJvamVjdCBuYW1lIGRvZXMgbm90LCBpdCdzIHN1YnN0cmFjdGVkIDEgcG9pbnQuXG4vLy9cbi8vLyBBcmd1bWVudHM6XG4vLy8gICAqIGBwcm9qZWN0X25hbWVgOiBgc3RyaW5nYCDigJMgdGhlIG5hbWUgb2YgdGhlIHByb2plY3Qgdy9vIHRoZSBvd25lcixcbi8vLyAgICogYHRhZ19uYW1lYDogYHN0cmluZ2Ag4oCTIHRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHRhZyxcbi8vLyAgICogYGFzc2V0c2A6IGBbb2JqZWN0XWAg4oCTIGFycmF5IG9mIGFzc2V0cyBhY3F1aXJlZCBmcm9tIHRoZSBHaXRIdWIgQVBJLFxuLy8vICAgKiBgcGxhdGZvcm1gOiBg4oiIIFBsYXRmb3JtYCDigJMgdGhlIHBsYXRmb3JtIHRvIHJhbmsgZm9yLlxuLy8vXG4vLy8gUmV0dXJuczogYFtvYmplY3RdYDogYHtzY29yZSwgZGF0YX1gIHdoZXJlIHNjb3JlIGlzIHRoZSByYW5rLCBoaWdoZXIgdGhlIGJldHRlciwgYW5kIGRhdGEgaXMgdGhlIG9yaWdpbmFsIGFzc2V0IG9iamVjdC5cbmV4cG9ydCBmdW5jdGlvbiByYW5rX2Fzc2V0cyhwcm9qZWN0X25hbWUsIHRhZ19uYW1lLCBhc3NldHMsIHBsYXRmb3JtKSB7XG5cdGlmKFBsYXRmb3JtLmFsbC5pbmRleE9mKHBsYXRmb3JtKSAhPT0gLTEgJiYgQXJyYXkuaXNBcnJheShhc3NldHMpICYmIHRhZ19uYW1lICYmIHByb2plY3RfbmFtZSkge1xuXHRcdGxldCBwcm9qZWN0X21hbiAgICAgICAgID0gTUFOVUFMX1JFR0VYLnRlc3QocHJvamVjdF9uYW1lKTtcblx0XHRsZXQgcHJvamVjdF9kb2MgICAgICAgICA9IERPQ1VNRU5UQVRJT05fUkVHRVgudGVzdChwcm9qZWN0X25hbWUpO1xuXHRcdGxldCBwbGF0Zm9ybV9uYW1lICAgICAgID0gUGxhdGZvcm0ubmFtZShwbGF0Zm9ybSk7XG5cdFx0bGV0IHBsYXRmb3JtX25hbWVfcmVnZXggPSBuZXcgUmVnRXhwKHBsYXRmb3JtX25hbWUsIFwiaVwiKTtcblxuXHRcdHJldHVybiBhc3NldHMubWFwKGRhdGEgPT4ge1xuXHRcdFx0bGV0IGRhdGFfbmFtZV9yZWR1Y2VkID0gZGF0YS5uYW1lO1xuXHRcdFx0Zm9yKGxldCBleHQgPSBcIlwiOyBleHQgIT09IHVuZGVmaW5lZDsgZXh0ID0gUEFDS19FWFRFTlNJT05TLmZpbmQoXyA9PiBkYXRhX25hbWVfcmVkdWNlZC5lbmRzV2l0aChfKSkpXG5cdFx0XHRcdGRhdGFfbmFtZV9yZWR1Y2VkID0gZGF0YV9uYW1lX3JlZHVjZWQuc3Vic3RyKDAsIGRhdGFfbmFtZV9yZWR1Y2VkLmxlbmd0aCAtIGV4dC5sZW5ndGgpO1xuXHRcdFx0ZGF0YV9uYW1lX3JlZHVjZWQgPSByZXBsYWNlX2FsbChkYXRhX25hbWVfcmVkdWNlZCwgdGFnX25hbWUsIFwiXCIpO1xuXHRcdFx0aWYodGFnX25hbWUuc3RhcnRzV2l0aChcInZcIikpXG5cdFx0XHRcdGRhdGFfbmFtZV9yZWR1Y2VkID0gcmVwbGFjZV9hbGwoZGF0YV9uYW1lX3JlZHVjZWQsIHRhZ19uYW1lLnN1YnN0cigxKSwgXCJcIik7XG5cblx0XHRcdGxldCBzY29yZSA9IDA7XG5cblx0XHRcdGlmKFBMQVRGT1JNU19SRUdFWEVTW3BsYXRmb3JtXS5zb21lKF8gPT4gXy50ZXN0KGRhdGFfbmFtZV9yZWR1Y2VkKSkpXG5cdFx0XHRcdHNjb3JlICs9IDI7XG5cblx0XHRcdGlmKHBsYXRmb3JtX25hbWVfcmVnZXgudGVzdChkYXRhX25hbWVfcmVkdWNlZCkpXG5cdFx0XHRcdHNjb3JlICs9IDE7XG5cblx0XHRcdGlmKCFwcm9qZWN0X21hbiAmJiBNQU5VQUxfUkVHRVgudGVzdChkYXRhX25hbWVfcmVkdWNlZCkpXG5cdFx0XHRcdHNjb3JlIC09IDE7XG5cblx0XHRcdGlmKCFwcm9qZWN0X2RvYyAmJiBET0NVTUVOVEFUSU9OX1JFR0VYLnRlc3QoZGF0YV9uYW1lX3JlZHVjZWQpKVxuXHRcdFx0XHRzY29yZSAtPSAxO1xuXG5cdFx0XHRyZXR1cm4ge3Njb3JlLCBkYXRhfTtcblx0XHR9KTtcblx0fSBlbHNlXG5cdFx0cmV0dXJuIFtdO1xufVxuXG4vLy8gQ2hlY2sgd2hldGhlciB0aGUgc3BlY2lmaWVkIGBhc3NldF9zcGVjYCBjb25maWcgc3Vib2JqZWN0IHNwZWNpZmllcyBhbiBhc3NldCBmb3IgdGhlIHNwZWNpZmllZCBwbGF0Zm9ybVxuLy8vXG4vLy8gQXJndW1lbnRzOlxuLy8vICAgKiBgY29uZmlnX2Fzc2V0X3NwZWNgOiBgb2JqZWN0YCDigJMgY29udGFpbnMgcGxhdGZvcm0gYXNzZXQgc3BlY2lmaWVycyxcbi8vLyAgICogYHBsYXRmb3JtYDogYOKIiCBQbGF0Zm9ybWAg4oCTIHRoZSBwbGF0Zm9ybSB0byByYW5rIGZvci5cbi8vL1xuLy8vIFJldHVybnM6IGBib29sZWFuYCDigJMgd2hldGhlciB0aGUgc3BlY2lmaWVkIHNwZWMgZGVmaW5lcyB3aGF0IGFzc2V0IHRvIHVzZSBvbiB0aGUgc3BlY2lmaWVkIHBsYXRmb3JtLlxuZXhwb3J0IGZ1bmN0aW9uIHNwZWNpZmllc19hc3NldHNfZm9yKGNvbmZpZ19hc3NldF9zcGVjLCBwbGF0Zm9ybSkge1xuXHRpZihQbGF0Zm9ybS5hbGwuaW5kZXhPZihwbGF0Zm9ybSkgIT09IC0xICYmIHR5cGVvZiBjb25maWdfYXNzZXRfc3BlYyA9PT0gXCJvYmplY3RcIiAmJiBjb25maWdfYXNzZXRfc3BlYyAhPT0gbnVsbClcblx0XHRyZXR1cm4gT2JqZWN0LmtleXMoY29uZmlnX2Fzc2V0X3NwZWMpLnNvbWUoXyA9PiBQTEFURk9STV9OQU1FX1JFR0VYRVNbcGxhdGZvcm1dLnRlc3QoXykgJiYgY29uZmlnX2Fzc2V0X3NwZWNbX10gIT09IG51bGwpO1xuXHRlbHNlXG5cdFx0cmV0dXJuIGZhbHNlO1xufVxuXG4vLy8gQ2hlY2sgd2hldGhlciB0aGUgc3BlY2lmaWVkIGBhc3NldF9zcGVjYCBjb25maWcgc3Vib2JqZWN0IHNwZWNpZmllcyBhbiBhc3NldCBmb3IgdGhlIHNwZWNpZmllZCBwbGF0Zm9ybVxuLy8vXG4vLy8gVGhlIGZpbGVuYW1lcyBpbiBgY29uZmlnX2Fzc2V0X3NwZWNgIGFyZSB0ZW1wbGF0YWJsZTpcbi8vLyAgICogYWxsIGluc3RhbmNlcyBvZiBgXCIke1RBR19OQU1FfVwiYCBhcmUgcmVwbGFjZWQgd2l0aCBgdGFnX25hbWVgLFxuLy8vICAgKiBhbGwgaW5zdGFuY2VzIG9mIGBcIiR7VEFHX05BTUVfUkVEVUNFRH1cImAgYXJlIHJlcGxhY2VkIHdpdGggYHRhZ19uYW1lYCB3aXRoIGAndidgIHN0cmlwcGVkIG9mZiB0aGUgZnJvbnQgKGlmIGFueSkuXG4vLy9cbi8vLyBBcmd1bWVudHM6XG4vLy8gICAqIGBjb25maWdfYXNzZXRfc3BlY2A6IGBvYmplY3RgIOKAkyBjb250YWlucyBwbGF0Zm9ybSBhc3NldCBzcGVjaWZpZXJzLFxuLy8vICAgKiBgcGxhdGZvcm1gOiBg4oiIIFBsYXRmb3JtYCDigJMgdGhlIHBsYXRmb3JtIHRvIHJhbmsgZm9yLlxuLy8vICAgKiBgYXNzZXRzYDogYFtvYmplY3RdYCDigJMgYXJyYXkgb2YgYXNzZXRzIGFjcXVpcmVkIGZyb20gdGhlIEdpdEh1YiBBUEksXG4vLy8gICAqIGB0YWdfbmFtZWA6IGBzdHJpbmdgIOKAkyB0aGUgbmFtZSBvZiB0aGUgY3VycmVudCB0YWcsXG4vLy9cbi8vLyBSZXR1cm5zOiBgb2JqZWN0P2Ag4oCTIHRoZSBleHRyYWN0ZWQgYXNzZXQgb2JqZWN0LCBpZiBhbnkuXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdF9hc3NldF9mb3IoY29uZmlnX2Fzc2V0X3NwZWMsIHBsYXRmb3JtLCBhc3NldHMsIHRhZ19uYW1lKSB7XG5cdGlmKHRhZ19uYW1lICYmIEFycmF5LmlzQXJyYXkoYXNzZXRzKSAmJiBzcGVjaWZpZXNfYXNzZXRzX2Zvcihjb25maWdfYXNzZXRfc3BlYywgcGxhdGZvcm0pKSB7XG5cdFx0bGV0IHRlbXBsYXRlID0gT2JqZWN0LmtleXMoY29uZmlnX2Fzc2V0X3NwZWMpLmZpbmQoXyA9PiBQTEFURk9STV9OQU1FX1JFR0VYRVNbcGxhdGZvcm1dLnRlc3QoXykpO1xuXHRcdGlmKHRlbXBsYXRlID09PSBudWxsIHx8ICh0ZW1wbGF0ZSA9IGNvbmZpZ19hc3NldF9zcGVjW3RlbXBsYXRlXSkgPT09IG51bGwpXG5cdFx0XHRyZXR1cm4gbnVsbDtcblxuXHRcdGxldCB0YWdfbmFtZV9yZWR1Y2VkID0gdGFnX25hbWU7XG5cdFx0aWYodGFnX25hbWVfcmVkdWNlZC5zdGFydHNXaXRoKFwidlwiKSlcblx0XHRcdHRhZ19uYW1lX3JlZHVjZWQgPSB0YWdfbmFtZV9yZWR1Y2VkLnN1YnN0cigxKTtcblxuXHRcdHRlbXBsYXRlID0gcmVwbGFjZV9hbGwodGVtcGxhdGUsIFwiJHtUQUdfTkFNRX1cIiwgdGFnX25hbWUpO1xuXHRcdHRlbXBsYXRlID0gcmVwbGFjZV9hbGwodGVtcGxhdGUsIFwiJHtUQUdfTkFNRV9SRURVQ0VEfVwiLCB0YWdfbmFtZV9yZWR1Y2VkKTtcblxuXHRcdHJldHVybiBhc3NldHMuZmluZChfID0+IF8ubmFtZSA9PT0gdGVtcGxhdGUpIHx8IG51bGw7XG5cdH0gZWxzZVxuXHRcdHJldHVybiBudWxsO1xufVxuIl19
